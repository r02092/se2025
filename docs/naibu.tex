\documentclass{docs}

%--- 基本パッケージ ---%
\usepackage[tmpdir]{graphviz} % フローチャートの作成
\usepackage{nicematrix}       % 複雑な表の作成
\usepackage{xpatch}           % コマンドの改造

%--- 文書情報 ---%
\title{内部設計書}

\makeatletter
	% GraphvizをLua経由で実行し、
	% 特殊な拡張子を持ったファイルを生成させ、
	% 日本語フォントを使用するよう改造
	% ※Lua経由で実行しないとファイルが生成されない
	% ※Latexmkでのビルド時に生成ファイルの変更が
	% 　毎回検知されるため、無視するように設定するために
	% 　特殊な拡張子を持たせている
	\renewcommand\@outext{pdflmi}
	\DeclareGraphicsRule{.pdflmi}{pdf}{*}{}
	\xpatchcmd\inputdigraph%
	{\immediate\write18{#3 -T\@outextspace -o \@tmpdir#2.\@outextspace \@tmpdir#2.dot}}%
	{
		\directlua{
			os.execute("#3 -Afontname='"..(os.getenv("GITHUB_ACTIONS")and"Hiragino Sans"or"BIZ UDPGothic").."' -Tpdf -o \@tmpdir#2.pdflmi \@tmpdir#2.dot")
		}
	}%
	{}{\errmessage{改造失敗}}
\makeatother
\setlength\arrayrulewidth{1pt}

% モジュール定義の表を描画するマクロ
% \modtable{モジュールID}{概要}{処理手順}{入力}{出力}{補足}
% 処理手順はGraphvizのDOT言語で記述
\newcommand\modtable[6]{
	\sffamily
	\begin{NiceTabularX}\textwidth{llX}[hvlines]
		\CodeBefore
		\rectanglecolor{lightgray}{1-1}{1-3}
		\rectanglecolor{lightgray}{2-1}{5-2}
		\rectanglecolor{lightgray}{6-1}{6-3}
		\rectanglecolor{lightgray}{8-1}{8-3}
		\rectanglecolor{lightgray}{10-1}{10-3}
		\rectanglecolor{lightgray}{12-1}{12-3}
		\Body
		\Block{1-3}{\emph{モジュール定義}} \\
		\Block{2-1}{\emph{管理情報}} & \emph{システム名} & SceneTrip \\
		& \emph{工程名} & 内部設計 \\
		\Block{2-1}{\emph{基本情報}} & \emph{モジュールID} & #1 \\
		& \emph{概要} & #2 \\
		\Block{1-3}{\emph{処理手順}} \\
		\Block{1-3}{
			\digraph[scale=.9]{#1}{
				#3
			}
		}
		\\
		\Block{1-3}{\emph{入力}} \\
		\Block[l]{1-3}{#4} \\
		\Block{1-3}{\emph{出力}} \\
		\Block[l]{1-3}{#5} \\
		\Block{1-3}{\emph{補足}} \\
		\Block[l]{1-3}{#6} \\
	\end{NiceTabularX}
}

\begin{document}
	\begin{table}[p]
		\centering
		\caption{検索画面の表示}\label{tab:mod-search}
		\modtable{M00}{検索画面を表示するモジュール}%
		{
			node [shape=diamond] c;
			node [shape=box,style=rounded] a;
			a [label="/にアクセスされる"];
			b [label="検索画面を生成"];
			c [label="ログインしているか"];
			d [label="ログイン時のUIを生成"];
			e [label="未ログイン時のUIを生成"];
			a->b;
			b->c;
			c->d [label="Yes"];
			c->e [label="No"];
		}%
		{利用者から受け取ったHTTPリクエスト}%
		{ウェブページ}%
		{}
	\end{table}
\end{document}
