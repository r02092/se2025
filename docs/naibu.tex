\documentclass{docs}

%--- 基本パッケージ ---%
\usepackage[tmpdir]{graphviz} % フローチャートの作成
\usepackage[verb]{bxghost}    % 和欧文間のアキを調整
\usepackage{dirtree}          % ディレクトリ構造の図を作成
\usepackage{mboxfill}         % 特定の文字で埋める
\usepackage{nicematrix}       % 複雑な表の作成
\usepackage{tabularx}         % 表の幅を調整
\usepackage{xpatch}           % コマンドの改造

%--- 文書情報 ---%
\title{内部設計書}

% \dotfillで埋める文字をGitHub Actions（ヒラギノ角ゴ）の場合に変更
\if"\directlua{tex.print(os.getenv("GITHUB_ACTIONS"))}"{}\else
	\renewcommand\dotfill{\mboxfill[3.333333pt]{\CID{9778}}}
\fi
\setlength\DTbaselineskip{9pt}

\makeatletter
	% GraphvizをLua経由で実行し、
	% 特殊な拡張子を持ったファイルを生成させ、
	% 日本語フォントを使用するよう改造
	% ※Lua経由で実行しないとファイルが生成されない
	% ※Latexmkでのビルド時に生成ファイルの変更が
	% 　毎回検知されるため、無視するように設定するために
	% 　特殊な拡張子を持たせている
	\renewcommand\@outext{pdflmi}
	\DeclareGraphicsRule{.pdflmi}{pdf}{*}{}
	\xpatchcmd\inputdigraph%
	{\immediate\write18{#3 -T\@outextspace -o \@tmpdir#2.\@outextspace \@tmpdir#2.dot}}%
	{
		\directlua{
			os.execute("#3 -Afontname='"..(os.getenv("GITHUB_ACTIONS")and"Hiragino Sans"or"BIZ UDPGothic").."' -Tpdf -o \@tmpdir#2.pdflmi \@tmpdir#2.dot")
		}
	}%
	{}{\errmessage{改造失敗}}
\makeatother

% モジュール定義の表を描画するマクロ
% \modtable{モジュールID}{名称}{概要}{処理手順}{入力}{出力}{補足}
% 処理手順はGraphvizのDOT言語で記述
\newcommand\modtable[7]{
	\sffamily
	\begingroup
		\setlength\arrayrulewidth{1pt}
		\begin{NiceTabularX}\textwidth{llX}[hvlines]
			\CodeBefore
			\rectanglecolor{lightgray}{1-1}{1-3}
			\rectanglecolor{lightgray}{2-1}{6-2}
			\rectanglecolor{lightgray}{7-1}{7-3}
			\rectanglecolor{lightgray}{9-1}{9-3}
			\rectanglecolor{lightgray}{11-1}{11-3}
			\rectanglecolor{lightgray}{13-1}{13-3}
			\Body
			\Block{1-3}{\emph{モジュール定義}} \\
			\Block{2-1}{\emph{管理情報}} & \emph{システム名} & SceneTrip \\
			& \emph{工程名} & 内部設計 \\
			\Block{3-1}{\emph{基本情報}} & \emph{モジュールID} & #1 \\
			& \emph{名称} & #2 \\
			& \emph{概要} & #3 \\
			\Block{1-3}{\emph{処理手順}} \\
			\Block{1-3}{
				\digraph[scale=.4]{#1}{
					#4
				}
			}
			\\
			\Block{1-3}{\emph{入力}} \\
			\Block[l]{1-3}{#5} \\
			\Block{1-3}{\emph{出力}} \\
			\Block[l]{1-3}{#6} \\
			\Block{1-3}{\emph{補足}} \\
			\Block[l]{1-3}{#7} \\
		\end{NiceTabularX}
	\endgroup
}

\begin{document}

% ====================================
\section{はじめに}
% 【記述内容】本設計書の目的、対象システムの概要、および外部設計書からの変更点を記述。

\section{システム概要}
本書は「聖地巡礼サポートシステムSceneTrip 外部設計書 第2.0版」
（以下、単に「外部設計書」と称する）に基づき、
システムのモジュール構成、データ処理ロジック、およびインターフェースの詳細を
定義する。
ただし、外部設計書と本書の内容に相違点がある場合、
本書に記述された内容を優先するものとする。
\subsection{共通機能}
\subsubsection{アカウント作成機能}
システムを利用するためにはアカウントを作成する必要がある。
アカウント作成時にはアカウント作成画面から
「ユーザー名」、「ログイン名」、「パスワード」、「確認用パスワード」
の4つの文字列を受け取り、文字列の検証とアカウントの作成を行う。
登録したアカウント情報（プロフィール）はログイン名を除き、プロフィール画面で編集可能とする。

\subsubsection{ログイン・ログアウト機能}
本システムにはアカウントの作成に伴い、ログイン及びログアウトの機能がある。
ログインを行うことで、ユーザーは本システムの全ての機能を利用できる。
一方ログインを行わない場合、利用できる機能はスポット検索機能に制限される。
ログインには本システムで作成するアカウントを使用する方法とGoogle アカウントを使用する方法がある。
本システムで作成したアカウントを使用する方法では、
システムはログイン用画面でログイン名とパスワードを受け取り、検証を行う。
Google アカウントを使用する方法では、OAuthを用いて認証を行い、
GoogleのIDとユーザー名から検証を行う。
また、RFC 6238に準拠したTOTPによる二要素認証に対応しており、
プロフィール画面から設定を行えるものとする。

\subsection{利用者（ログイン不要）}
\subsubsection{スポット検索}
検索処理は、キーワードとカテゴリを入力として受け取り、入力値の検証を行う。
検索結果には、スポット（観光地や施設等）の詳細情報を表示する。

\subsection{利用者（ログイン必須）}

\subsubsection{経路作成}
ユーザーが入力した出発地・到着地となるスポットを基に
Gemini APIを利用してGeminiから中継地点となるスポットとともに
経路の提案を取得し、ユーザーに返す。
加えて、Geminiからの回答をより正確にするために、
スポットを住所によって市区町村単位に分類し、
Geminiへのヒントを与える。
更に、Geminiから提案されたスポットはその経度・緯度から
出発地・到着地によって矩形に囲まれる範囲に収まるスポットに限定し、
提案する経路を調整する。

\subsubsection{Google マップによる経路案内機能}
ユーザーとGeminiからの入力によって得られたスポットを経由する
経路を、Google マップの埋め込み機能を用いて表示する。

\subsubsection{評価機能}
スポットに5段階の評価とコメントを投稿できる。
システムはそれらをスポットに関連付ける。

\subsubsection{写真投稿・共有機能}
場所に関連付けて地図上に表示される写真及びコメントを投稿できる。
システムは写真とコメントを該当する経度、緯度と関連付ける。

\subsubsection{チェックイン機能}
現地まで赴いた実績として訪れたスポットのスタンプを入手できる機能である。
システムはユーザーのカメラ映像から二次元コードを読み取り、
同時にデバイスの位置情報を基に誤差範囲を利用してユーザーがスポットの周囲に位置していることを確認する。

\subsubsection{クーポンの受け取り・利用機能}
本システム上で提供されるクーポンの受け取り、並びにそのクーポンの利用ができる。
クーポンはスポットなどでの割引や特典に利用できる。
クーポンは、利用可能・利用中・利用済み・期限切れの4状態で表示する。
クーポンの「利用中」とは、クーポンを提示して店舗などで利用手続きを行った状態を指し、
翌日午前5時に「利用済み」となる。
ユーザーは画面上でクーポンが「利用可能」なのか、「利用中」なのかを確認できるものとする。

\subsection{事業者}
\subsubsection{サブスクリプション登録機能}
本システムのスタンダードプランまたはプレミアムプランへの登録の申請を行う機能である。
登録されたプランは、各プランの契約数としてアカウントに紐づく。
また、申請時に郵便番号と住所を受け取り、アカウントに関連付ける。

\subsubsection{スポット情報管理機能}
スポットの追加、情報の編集、削除を行う機能である。
システムはスポットを追加する際にスポットの名前、種別、所在地を取得する。
追加したスポットの情報は後で編集、削除できる。

\subsubsection{事業者情報変更機能}
登録した店舗情報（店舗名、所在地、紹介文、店舗写真など）を変更する機能である。

\subsubsection{観光データ分析API}
システムはユーザーの検索履歴やクーポンの使用履歴を記録し、
そのデータを取得できるAPIを提供する。

\subsubsection{クーポン発行機能}
システム上でクーポンを発行できる。
これはサブスクリプションに登録したアカウントのみで行うことができるものとする。
作成時に使用できるスポット、クーポン名、行く必要のあるスポット、期限を入力する必要がある。

\subsubsection{請求書ダウンロード機能}
PDF形式のファイルをダウンロードすることで、請求書を受領できるものとする。

\subsection{管理者}

\subsubsection{ユーザー管理}
アカウントの作成、ユーザー情報の編集、削除を行う機能である。

\subsubsection{UGCの監視・管理機能}
UGCの監視、投稿の削除ができる機能である。
システムは管理者が投稿された口コミやフォトスポット投稿について、
利用規約違反があると判断した場合、
投稿の削除を行えるものとする。

\subsubsection{分析データ閲覧機能}
観光分析APIで提供するデータを閲覧する機能である。

\subsubsection{サブスクリプション承認・解除機能}
事業者からのサブスクリプション登録の申請の承認または却下、
サブスクリプションの解除または停止を行う機能である。
システムは管理者が事業者の未払いや、規約違反があると判断した場合、
強制的にサブスクリプションを解除または停止できるものとする。

\section{適用範囲と制約}
外部設計書で指定されたパッケージ構成や
開発言語、セキュリティに関する要件などを変更せずに作成する。
ただし、データベース設計については本書に記述するものに
変更する。

% ====================================

\newpage
\section{技術スタック}
% 【記述内容】使用するプログラミング言語、フレームワーク、主要ライブラリを記述。
本システムは\cref{tab:tech}に示す技術を使用する。
\begin{table}[H]
	\centering
	\caption{技術スタック}\label{tab:tech}
	\begin{tabularx}{0.9\textwidth}{|p{13\zw}|X|l|}
		\hline
		\thead{項目} & \thead{ソフトウェア} & \thead{備考} \\ \hline
		Webサーバ & Nginx & \\ \hline
		データベース & MariaDB & \\ \hline
		バックエンド開発言語 & PHP & \\ \hline
		バックエンドパッケージマネージャ & Composer & \\ \hline
		バックエンドフレームワーク & Laravel & \\ \hline
		バックエンド単体テスト & PHPUnit & \\ \hline
		ソーシャルログイン & Laravel Socialite & \\ \hline
		フロントエンド開発言語 & TypeScript & \\ \hline
		フロントエンドランタイム & Node.js & \\ \hline
		Node.jsバージョン管理 & Node Version Manager & \\ \hline
		フロントエンドパッケージマネージャ & pnpm & \\ \hline
		フロントエンドバンドラ & Vite & \\ \hline
		フロントエンドテスト & Vitest & \\ \hline
		E2Eテスト & Playwright & \\ \hline
		PDFファイルの作成 & tFPDF & \\ \hline
		PDFファイルの加工 & FPDI & \\ \hline
		二次元コードの作成 & Bacon/BaconQrCode & \\ \hline
		二次元コードの読み取り & nimiq/qr-scanner & \\ \hline
		地図表示 & MapLibre GL JS & \\ \hline
		LLM & Gemini 2.5 Flash-Lite & Google AI Studioを使用 \\ \hline
		地図 & OpenStreetMap & \\ \hline
		% 交通情報 & 国土交通省交通量API & \\ \hline
	\end{tabularx}
\end{table}

\section{開発環境}
% 【記述内容】動作環境と同様に開発環境について書く
本システムは、GitHubでソースコードを管理し、GitHubに
搭載されたCI/CDツールであるGitHub Actionsを開発に用いる。
本文書を含めたシステムに関わる文書を管理するリポジトリと共通のリポジトリを
用いる。
また、コードフォーマッタであるPrettierおよび
リンタであるESLintとLarastanを用いる。

GNU/LinuxシステムまたはWindowsで動作するPCを開発用PCとして用いる。
開発用PCには、Node Version Managerをインストールし、
それを用いてNode.jsをインストールし、それに含まれるnpmを用いてpnpmを
インストールするものとする。
また、開発用PCにコンテナを用いて\cref{tab:dev-con}に示す環境を作成し、開発を行う。
コンテナ管理ツールとしてはPodmanまたはDockerを用いる。
\begin{table}[H]
	\centering
	\caption{開発環境}\label{tab:dev-con}
	\begin{tabularx}{0.9\textwidth}{|l|X|p{10\zw}|}
		\hline
		\thead{項目} & \thead{ソフトウェア} & \thead{備考} \\ \hline
		OS & Alpine 3.23 & \\ \hline
		PHP実行環境 & PHP 8.3 & \\ \hline
		データベース & MariaDB 10.11.14 & \\ \hline
		自動レビュ & Reviewdog v0.18.1 & \\ \hline
	\end{tabularx}
\end{table}
GitHub Actionsでは、以下の作業を自動で行う。
\begin{itemize}
	\item \emph{\LaTeX 文書のコンパイル}
	\begin{itemize}
		\item 特定の形式のGitタグがプッシュされた際に動作
		\item 文書に用いるフォントの都合上、macOSのイメージ上で動作
		\item Mac\TeX の環境の構築に時間がかかるため、6日毎に
		環境のキャッシュを作成
	\end{itemize}
	\item \emph{Pull Requestの自動確認}
	\begin{itemize}
		\item フォーマッタによる整形を自動でコミット
		\item リンタによる指摘箇所をReviewdogでコメント
		\item リンタによる指摘内容が英語の場合、日本語に自動翻訳
		\item PHPUnitによるバックエンドの自動での単体テスト
	\end{itemize}
	\item \emph{Google App Scriptのデプロイ}
	\begin{itemize}
		\item 翻訳APIの呼び出しに使用
	\end{itemize}
	\item \emph{システム全体のデプロイ}
\end{itemize}
\cref{tab:dev-latex}および\cref{tab:dev-gha}に、GitHub Actionsワークフローで
用いる環境を示す。
この表に書いていない細かなソフトウェアは、
パッケージ管理システム（UbuntuであればAPT、macOSで
あればHomebrew）で導入されるバージョンを使用する。
\begin{table}[H]
	\centering
	\caption{\LaTeX 文書をコンパイルするGitHub Actionsワークフローで用いる環境}\label{tab:dev-latex}
	\begin{tabularx}{0.9\textwidth}{|l|X|p{10\zw}|}
		\hline
		\thead{項目} & \thead{ソフトウェア} & \thead{備考} \\ \hline
		OS & macOS Sequoia & \\ \hline
		\TeX ディストリビューション & Mac\TeX{} 2025 & \\ \hline
	\end{tabularx}
\end{table}
\begin{table}[H]
	\centering
	\caption{その他のGitHub Actionsワークフローで用いる環境}\label{tab:dev-gha}
	\begin{tabularx}{0.9\textwidth}{|l|X|p{10\zw}|}
		\hline
		\thead{項目} & \thead{ソフトウェア} & \thead{備考} \\ \hline
		OS & Ubuntu 24.04.3 & \\ \hline
		PHP実行環境 & PHP 8.3 & \\ \hline
		データベース & MariaDB 10.11.13 & \\ \hline
		自動レビュ & Reviewdog v0.18.1 & \\ \hline
	\end{tabularx}
\end{table}

また、リポジトリには依存関係のアップデートを行い、Pull Requestを
自動で作成するbotであるRenovateを導入する。
これにより、Composerおよびpnpmで管理する依存関係やGitHub Actionsの
依存関係、Node.jsのアップデートを自動で行い、最新の状態に保つ。

\section{動作環境}
% 【記述内容】OS、Webサーバー、データベース、ネットワークなど、システムが稼働する環境を具体的に記述
本システムは\cref{tab:honban}に示す環境で動作させる。
\begin{table}[H]
	\centering
	\caption{動作環境}\label{tab:honban}
	\begin{NiceTabularX}{0.9\textwidth}{p{6\zw}Xp{4\zw}p{10\zw}}[hvlines]
		\thead{項目} & \thead{種類} & \thead{数量} & \thead{備考} \\
		メインサーバ & OCI Compute & 1台 & Always Freeサービス（無料枠）\\
		データベースサーバ & OCI Compute & 1台 & Always Freeサービス（無料枠）\\
		管理者端末 & PCおよびスマートフォン & 管理者数 & \\
		利用者端末 & PCおよびスマートフォン & 利用者数 & \\
		端末OS & Android、Linux、Windows、iOS、macOS & \diagbox{}{} & \\
		端末ブラウザ & Firefox、Google Chrome、Safari & \diagbox{}{} & \\
	\end{NiceTabularX}
\end{table}

\section{コーディング規約}
% 【記述内容】命名規則（クラス名、変数名）、インデント、コメントの書き方、セキュリティ上の規約などを定義。
\begin{itemize}
	\item \emph{共通}
	\begin{itemize}
		\item 文字コードは、BOMを付与しないUTF-8を用いる。
		\item 改行コードは、LFを用いる。
		\item 各ファイルの末尾は、改行とする。
		\item 各行の末尾に1つ以上のタブおよびスペースの
		連続が存在しないようにする。
		\item 原則として、各行の文字数は最大で80文字程度と
		する。この規則において、全角文字は2文字、
		タブは4文字として数える。
		\item 何らかの要素の列挙について、
		最後の要素の後の末尾のカンマは、
		列挙が改行を伴いかつ挿入が可能であれば挿入し、
		そうでない場合は挿入しないものとする。
		\item 可能な場合、Prettierを用いてコードの
		自動整形を行う。
		設定は、ここに記述する規約を可能な限り
		適用するものとする。
		\item 環境変数の命名には、アッパースネークケースを用いる。
		\item ここに記述する規約は、依存関係などの\verb|.gitignore|ファイルで無視するファイルには
		適用しないものとする。
	\end{itemize}
	\item \emph{PHPコード}
	\begin{itemize}
		\item インデントには、スペース4つを用いる。
		\item 文字列には、優先的にシングルクォートを用いる。
		ダブルクォートよりシングルクォートを多く含む文字列や
		変数展開を用いる場合など、ダブルクォートを
		用いることが好ましい場合は、ダブルクォートを用いる。
		\item コードブロックを構成する括弧は、
		インデントとそれのみを含む単一の行に配置する。
		\item PHPStanの指摘が起きないようにする。
		設定は、デフォルトのルールを用い、
		必要に応じて開発中に変更するものとする。
		\item クラスおよびトレイト、名前空間の命名には、アッパーキャメルケースを用いる。
		\item 関数および変数の命名には、ローワーキャメルケースを用いる。
		\item 定数の命名には、アッパースネークケースを用いる。
		\item データベースのテーブルおよびカラムの命名には、
		ローワースネークケースを用いる。
		\item \verb|App\Http\Controllers\Controller|クラスを継承するクラスの名前の
		末尾は、\verb|Controller|とする。
		\item \verb|App\Models\|名前空間に存在するクラスの
		名前は、対応するデータベースのテーブル名を
		英語として解釈し、それを単数形にしたものとする。
		\item \verb|App\Http\Controllers\Controller|クラスを継承するクラスから
		呼び出される共通処理は、\verb|App\Traits\|名前空間に
		属するトレイトとする。
		\item \verb|App\Traits\|名前空間に属するトレイトの
		名前の末尾は、\verb|Trait|とする。
		\item クラスと対応するファイルの場所は、PSR-4に準拠したオートローダで読み込み可能な場所とする。
		ただし、名前空間とディレクトリには\cref{tab:coding-psr4}のような対応付けがあるものとする。
		\begin{table}[H]
			\centering
			\caption{名前空間とディレクトリの対応付け}\label{tab:coding-psr4}
			\begin{tabularx}{0.9\textwidth}{|X|X|}
				\hline
				\thead{名前空間} & \thead{ディレクトリ} \\ \hline
				\texttt{App\textbackslash} & \texttt{app/} \\ \hline
				\texttt{Database\textbackslash Factories\textbackslash} & \texttt{database/factories/} \\ \hline
				\texttt{Database\textbackslash Seeders\textbackslash} & \texttt{database/seeders/} \\ \hline
				\texttt{Tests\textbackslash} & \texttt{tests/} \\ \hline
			\end{tabularx}
		\end{table}
		\item クラスと対応しないファイルは、\cref{sec:dir}で定めたディレクトリに配置するものとする。
		\item クラスと対応しないファイルの名前は、\verb|artisan|ファイルを除き、
		ローワースネークケースを用いた名前の末尾に“\verb|.php|”を付与するものとする。
	\end{itemize}
	\item \emph{Bladeテンプレート}
	\begin{itemize}
		\item インデントには、タブを用いる。
		\item HTMLタグが改行を伴って記述される場合、
		タグの閉じ括弧は、インデントとそれのみを含む
		単一の行に配置する。
		\item 要素の名前は、半角英数字列とする。
		\item カスタム属性の名前は、ケバブケースを用いた名前の先頭に“\verb|data-|”を付与するものとする。
		\item IDの命名には、ローワースネークケースを用いる。
		\item クラスの命名には、ケバブケースを用いる。
		\item ファイルは、\verb|resources/views/|ディレクトリに配置するものとする。
		\item ファイル名は、ケバブケースを用いた名前の末尾に“\verb|.blade.php|”を
		付与するものとする。
	\end{itemize}
	\item \emph{CSSスタイルシート}
	\begin{itemize}
		\item インデントには、タブを用いる。
		\item 0には単位を付与しないものとする。
		\item 要素やカスタム属性、ID、クラスの
		命名規則は、Bladeテンプレートのものに従う。
		\item ルールセット内で、関連する内容の
		プロパティ（同じプレフィックスをもつものなど）が
		存在する場合、それらを連続させるような順序で
		記述する。
		\item ファイルは、\verb|resources/css/|ディレクトリ配下に配置するものとする。
		\item ファイル名は、ローワースネークケースを用いた名前の末尾に“\verb|.css|”を付与するものとする。
	\end{itemize}
	\item \emph{TypeScriptコード}
	\begin{itemize}
		\item インデントには、タブを用いる。
		\item 文は、セミコロンで区切る。
		\item 文字列には、優先的にダブルクォートを用いる。
		シングルクォートよりダブルクォートを多く含む
		文字列など、シングルクォートを用いることが
		好ましい場合は、シングルクォートを用いる。
		\item オブジェクトのプロパティ名は、必要な場合のみ
		クォートで囲むものとする。
		\item オブジェクト内の要素と括弧の間には、
		スペースを挿入しないものとする。
		\item アロー関数の引数が1つの場合、引数を囲う括弧は
		省略する。
		\item ESLintの指摘が起きないようにする。
		設定は、デフォルトのルールを用い、
		必要に応じて開発中に変更するものとする。
		\item クラスおよび名前空間の命名には、アッパーキャメルケースを用いる。
		\item 関数および変数、定数の命名には、ローワーキャメルケースを用いる。
		\item ファイルは、\verb|resources/ts/|ディレクトリ配下に配置するものとする。
		\item ファイル名は、ローワースネークケースを用いた名前の末尾に“\verb|.ts|”を付与するものとする。
	\end{itemize}
\end{itemize}

% ====================================

\newpage
\section{ディレクトリ構造}\label{sec:dir}
ディレクトリ構造を示す図を\cref{fig:dir}に示す。
\begin{figure}[H]
	{
		\footnotesize
		\dirtree{%
			.1 se2025\textrm{\DTcomment{リポジトリのルート}}.
			.2 .github\textrm{\DTcomment{リモートリポジトリ関連の設定}}.
			.3 workflows\textrm{\DTcomment{GitHub Actionsのワークフロー}}.
			.2 .vscode\textrm{\DTcomment{Visual Studio Codeの設定}}.
			.2 app\textrm{\DTcomment{システムの主な処理を行うプログラム}}.
			.3 Http\textrm{\DTcomment{HTTPリクエストがあった場合に実行されるプログラム}}.
			.4 Controllers\textrm{\DTcomment{ルーティングから呼び出されるコントローラとなるプログラム}}.
			.3 Models\textrm{\DTcomment{データベースのテーブルが表現する実体に対応したクラスを定義するプログラム}}.
			.3 Providers\textrm{\DTcomment{サービスプロバイダとなるプログラム}}.
			.3 Traits\textrm{\DTcomment{コントローラから呼び出される共通処理となるプログラム}}.
			.2 bootstrap\textrm{\DTcomment{システムの起動時の処理を行うプログラム}}.
			.3 cache.
			.2 config\textrm{\DTcomment{システムの設定を記述するファイル}}.
			.2 database\textrm{\DTcomment{データベース関連のプログラム}}.
			.3 factories\textrm{\DTcomment{ダミーのレコードの定義を行うプログラム}}.
			.3 migrations\textrm{\DTcomment{テーブルの作成などを行うプログラム}}.
			.3 seeders\textrm{\DTcomment{ダミーのレコードの挿入を行うプログラム}}.
			.2 dev\textrm{\DTcomment{開発用コンテナ関連のファイル}}.
			.3 db\textrm{\DTcomment{開発用コンテナ内のデータベースのマウントポイント}}.
			.2 docs\textrm{\DTcomment{システム提案書や外部設計書、内部設計書のような文書}}.
			.3 figure\textrm{\DTcomment{文書に使用する図}}.
			.3 tmp\textrm{\DTcomment{文書に使用する自動生成された図}}.
			.2 gas\textrm{\DTcomment{Google App Scriptのデプロイに用いるファイル}}.
			.3 dist\textrm{\DTcomment{ViteによってビルドされたGoogle App Script}}.
			.2 node\_modules\textrm{\DTcomment{Node.jsのパッケージ}}.
			.2 public\textrm{\DTcomment{Webサーバのドキュメントルート}}.
			.3 build\textrm{\DTcomment{Viteによってビルドされたフロントエンド関連のファイル}}.
			.4 assets\textrm{\DTcomment{CSSスタイルシートとJavaScriptコード}}.
			.2 resources\textrm{\DTcomment{フロントエンド関連のファイル}}.
			.3 css\textrm{\DTcomment{CSSスタイルシート}}.
			.3 ts\textrm{\DTcomment{TypeScriptコード}}.
			.4 ci\textrm{\DTcomment{CIで使用するスクリプト}}.
			.4 e2e\textrm{\DTcomment{E2Eテスト用のテストスクリプト}}.
			.3 views\textrm{\DTcomment{Bladeテンプレート}}.
			.2 routes\textrm{\DTcomment{ルーティング関連のファイル}}.
			.2 storage\textrm{\DTcomment{Laravelが生成・使用するファイル}}.
			.3 app.
			.4 private.
			.4 public.
			.3 framework.
			.4 cache.
			.5 data.
			.4 sessions.
			.4 testing.
			.4 views.
			.3 logs.
			.2 tests\textrm{\DTcomment{PHPUnitのテストスクリプト}}.
			.3 Feature\textrm{\DTcomment{機能テストのテストスクリプト}}.
			.3 Unit\textrm{\DTcomment{単体テストのテストスクリプト}}.
			.2 vendor\textrm{\DTcomment{Composerのパッケージ}}.
		}
	}
	\caption{主なディレクトリの一覧}\label{fig:dir}
\end{figure}

\section{データベース設計}
\subsection{ER図}
IE記法によるデータベースのER図を\cref{fig:er}に示す。
\begin{figure}[H]
	\centering
	\includegraphics[bb=16.408054 15.39 668.505917 581.561982,clip,scale=.66]{naibu-er.pdf}
	\caption{ER図}\label{fig:er}
\end{figure}
\subsection{テーブルとカラムの詳細}
各テーブルおよびカラムの詳細を示す。
IDについて特筆なきものは、AUTO INCREMENT属性を
指定することで自動で採番を行うものとする。
経緯度については、以下に示す式を用いて度単位の値を変換し、
得られた値を格納する。
この変換は、各テーブルに対応するモデルとなるモジュールにて
行う。
\[
	\text{[データベースに格納する値]}=\frac{\text{[元の値]}-\text{[最小値]}}{\text{[最大値]}-\text{[最小値]}}(2^{32}-1)
\]
このシステムでは、管理者や事業者を含む全ての利用者を
共通のusersテーブル（\cref{tab:db-users}）で扱う。
ログインにはGoogle アカウントも使用できるため、
\cref{tab:db-users-provider}に値の意味を示すproviderカラムで
アカウントのサービスプロバイダを区別し、
識別子をlogin\_nameカラムに保存する。
この設計によって、ソーシャルログインの
サービスプロバイダの将来的な拡張も容易となるようにする。

管理者であるかどうかは、\cref{tab:db-users-permission}に
示すようにpermissionカラムの値により区別する。
事業者であるかどうかの区別には
契約の数を記録するカラムを用い、1つ以上の契約があれば
事業者であると判断する。

事業者の場合、住所の登録を要するものとする。
住所は郵便番号およびJIS X 0402:2020で
定められた市区町村コード（JIS X 0401:1973で定められた
都道府県コードと併用するもの、これ以降に述べる場合も同様）と
市区町村に続く住所の文字列の
組合せにより保存する。

また、ログイン時にTOTPによる二要素認証を
行えるようにするためのカラムを設ける。
総当たり攻撃を防ぐため、直近の認証時の時刻と
認証回数を保持するカラムも設けており、
高頻度な認証操作を制限する。OTPの更新頻度は30秒と
するため、直近の認証時の時刻は、UNIX時刻を30で
割った値として保存し、認証回数も30秒ごとに数え直す。
\begin{table}[H]
	\centering
	\caption{usersテーブル（管理者や事業者を含む利用者）}\label{tab:db-users}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{カラム名} & \thead{データ型} & \thead{制約} & \thead{説明} \\ \hline
		id & INT UNSIGNED & PK & ID \\ \hline
		provider & TINYINT UNSIGNED & UK, NOT NULL & サービスプロバイダ \\ \hline
		login\_name & VARCHAR(255) & UK, NOT NULL & ログイン名 \\ \hline
		password & VARCHAR(255) & & ハッシュ化されたパスワード \\ \hline
		permission & TINYINT UNSIGNED & NOT NULL & 種別 \\ \hline
		name & VARCHAR(255) & NOT NULL & 名前 \\ \hline
		icon\_ext & VARCHAR(4) & NOT NULL & アイコンの拡張子 \\ \hline
		num\_plan\_std & INT UNSIGNED & NOT NULL & スタンダードプランの契約数 \\ \hline
		num\_plan\_prm & INT UNSIGNED & NOT NULL & プレミアムプランの契約数 \\ \hline
		postal\_code & INT UNSIGNED & & 郵便番号 \\ \hline
		addr\_city & INT UNSIGNED & & 市区町村コード \\ \hline
		addr\_detail & VARCHAR(255) & & 市区町村名の後に続く住所 \\ \hline
		totp\_secret & BINARY(20) & & TOTPのシークレット \\ \hline
		totp\_iv & BINARY(12) & & TOTPの初期ベクトル \\ \hline
		totp\_tag & BINARY(16) & & TOTPの認証タグ \\ \hline
		totp\_last\_time & INT UNSIGNED & & TOTPの直近の認証時の時刻 \\ \hline
		totp\_counter & TINYINT UNSIGNED & & TOTPの30秒ごとの認証回数 \\ \hline
		created\_at & DATETIME & & 作成時刻 \\ \hline
		updated\_at & DATETIME & & 更新時刻 \\ \hline
		deleted\_at & DATETIME & & 削除時刻 \\ \hline
	\end{tabular}
\end{table}
\begin{table}[H]
	\centering
	\caption{usersテーブルのproviderカラムについて}\label{tab:db-users-provider}
	\begin{tabular}{|r|l|}
		\hline
		\multicolumn{1}{|c|}{\thead{値}} & \thead{意味} \\ \hline
		0 & SceneTrip \\ \hline
		1 & Google \\ \hline
	\end{tabular}
\end{table}
\begin{table}[H]
	\centering
	\caption{usersテーブルのpermissionカラムについて}\label{tab:db-users-permission}
	\begin{tabular}{|r|l|}
		\hline
		\multicolumn{1}{|c|}{\thead{値}} & \thead{意味} \\ \hline
		0 & 管理者 \\ \hline
		1 & 利用者（未承認の事業者を含む） \\ \hline
		2 & 承認済み事業者 \\ \hline
	\end{tabular}
\end{table}
パスワードのハッシュ化にはPHPの\verb|password_hash()|関数を
使用し、暗号学的ハッシュ関数であるArgon2idを用い、かつ
ソルトを使用することで、安全にパスワードを保存する。

spotsテーブル（\cref{tab:db-spots}）は、
観光地や観光施設、店などのスポットを保存する。
スポットは契約ごとに作成できるため、
どちらのプランに対応するスポットであるかを保存するplanカラムを設けている。
このカラムの値の意味を\cref{tab:db-spots-plan}に示す。
また、\cref{tab:db-spots-type}にカテゴリを表す値の一覧を
示す。keywordsテーブル（\cref{tab:db-keywords}）
スポットにはキーワードを関連付ける。

スポットのカテゴリや名前、経緯度、住所、
キーワードはAI検索時のLLMのシステムプロンプトの構成などに
使用する。
\begin{table}[H]
	\centering
	\caption{spotsテーブル（観光地や観光施設、店などのスポット）}\label{tab:db-spots}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{カラム名} & \thead{データ型} & \thead{制約} & \thead{説明} \\ \hline
		id & INT UNSIGNED & PK & ID \\ \hline
		user\_id & INT UNSIGNED & FK, NOT NULL & 登録者 \\ \hline
		plan & TINYINT UNSIGNED & NOT NULL & プラン \\ \hline
		type & TINYINT UNSIGNED & NOT NULL & カテゴリ \\ \hline
		name & VARCHAR(255) & NOT NULL & 名前 \\ \hline
		lng & INT UNSIGNED & NOT NULL & 経度 \\ \hline
		lat & INT UNSIGNED & NOT NULL & 緯度 \\ \hline
		postal\_code & INT UNSIGNED & & 郵便番号 \\ \hline
		addr\_city & INT UNSIGNED & & 市区町村コード \\ \hline
		addr\_detail & VARCHAR(255) & & 市区町村名の後に続く住所 \\ \hline
		description & TEXT & NOT NULL & 説明文 \\ \hline
		img\_ext & VARCHAR(4) & NOT NULL & 画像の拡張子 \\ \hline
		stamp\_key & BIGINT UNSIGNED & UK2, NOT NULL & スタンプ確認用キー \\ \hline
		created\_at & DATETIME & & 作成時刻 \\ \hline
		updated\_at & DATETIME & & 更新時刻 \\ \hline
		deleted\_at & DATETIME & & 削除時刻 \\ \hline
	\end{tabular}
\end{table}
\begin{table}[H]
	\centering
	\caption{spotsテーブルのplanカラムについて}\label{tab:db-spots-plan}
	\begin{tabular}{|r|l|}
		\hline
		\multicolumn{1}{|c|}{\thead{値}} & \thead{意味} \\ \hline
		0 & スタンダードプラン \\ \hline
		1 & プレミアムプラン \\ \hline
	\end{tabular}
\end{table}
\begin{table}[H]
	\centering
	\caption{spotsテーブルのtypeカラムについて}\label{tab:db-spots-type}
	\begin{tabular}{|r|l|}
		\hline
		\multicolumn{1}{|c|}{\thead{値}} & \thead{意味} \\ \hline
		0 & 飲食 \\ \hline
		1 & お土産 \\ \hline
		2 & 観光 \\ \hline
		3 & 体験アクティビティ \\ \hline
		4 & 宿泊 \\ \hline
		5 & 公共施設 \\ \hline
		6 & 公共交通機関 \\ \hline
		255 & その他 \\ \hline
	\end{tabular}
\end{table}
\begin{table}[H]
	\centering
	\caption{keywordsテーブル（スポットに関連付けるキーワード）}\label{tab:db-keywords}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{カラム名} & \thead{データ型} & \thead{制約} & \thead{説明} \\ \hline
		id & INT UNSIGNED & PK & ID \\ \hline
		spot\_id & INT UNSIGNED & FK, UK, NOT NULL & 関連付けたスポット \\ \hline
		keyword & VARCHAR(255) & UK, NOT NULL & キーワード \\ \hline
		created\_at & DATETIME & & 作成時刻 \\ \hline
		updated\_at & DATETIME & & 更新時刻 \\ \hline
		deleted\_at & DATETIME & & 削除時刻 \\ \hline
	\end{tabular}
\end{table}
スポットに対する
口コミは、reviewsテーブル（\cref{tab:db-reviews}）に
保存する。口コミには、段階的な評価および文章を
入力できるようにする。
また、閲覧数も記録するようにし、
よく閲覧されている口コミを事業者が確認できるようにする。
\begin{table}[H]
	\centering
	\caption{reviewsテーブル（スポットに対する口コミ）}\label{tab:db-reviews}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{カラム名} & \thead{データ型} & \thead{制約} & \thead{説明} \\ \hline
		id & INT UNSIGNED & PK & ID \\ \hline
		spot\_id & INT UNSIGNED & FK, NOT NULL & 関連付けたスポット \\ \hline
		user\_id & INT UNSIGNED & FK, NOT NULL & 投稿者 \\ \hline
		rate & TINYINT UNSIGNED & NOT NULL & 評価 \\ \hline
		comment & TEXT & NOT NULL & 本文 \\ \hline
		views & INT UNSIGNED & NOT NULL & 閲覧数 \\ \hline
		ip\_addr & VARBINARY(16) & NOT NULL & IPアドレス \\ \hline
		port & SMALLINT UNSIGNED & NOT NULL & ポート番号 \\ \hline
		user\_agent & VARCHAR(255) & NOT NULL & User-Agent \\ \hline
		created\_at & DATETIME & & 作成時刻 \\ \hline
		updated\_at & DATETIME & & 更新時刻 \\ \hline
		deleted\_at & DATETIME & & 削除時刻 \\ \hline
	\end{tabular}
\end{table}
事業者が発行した
クーポンはcouponsテーブル（\cref{tab:db-coupons}）に保存する。
クーポンを手に入れるために行く必要のあるスポットも記録する。
また、利用者が手に入れた
クーポンはuser\_couponsテーブル（\cref{tab:db-user_coupons}）に
保存する。クーポンの入手時に確認用キーが生成され、
これを含む二次元コードを事業者に提示することで
正規のクーポンであることを証明する。
\begin{table}[H]
	\centering
	\caption{couponsテーブル（スポットに対して作成されたクーポン）}\label{tab:db-coupons}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{カラム名} & \thead{データ型} & \thead{制約} & \thead{説明} \\ \hline
		id & INT UNSIGNED & PK & ID \\ \hline
		spot\_id & INT UNSIGNED & FK, NOT NULL & 使用できるスポット \\ \hline
		name & VARCHAR(255) & NOT NULL & 名前 \\ \hline
		cond\_spot\_id & INT UNSIGNED & & 行く必要のあるスポット \\ \hline
		expires\_at & DATETIME & & 期限切れ時刻 \\ \hline
		created\_at & DATETIME & & 作成時刻 \\ \hline
		updated\_at & DATETIME & & 更新時刻 \\ \hline
		deleted\_at & DATETIME & & 削除時刻 \\ \hline
	\end{tabular}
\end{table}
\begin{table}[H]
	\centering
	\caption{user\_couponsテーブル（利用者が手に入れたクーポン）}\label{tab:db-user_coupons}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{カラム名} & \thead{データ型} & \thead{制約} & \thead{説明} \\ \hline
		id & INT UNSIGNED & PK & ID \\ \hline
		coupon\_id & INT UNSIGNED & FK, UK1, NOT NULL & 関連付けたクーポン \\ \hline
		user\_id & INT UNSIGNED & FK, UK1, NOT NULL & 手に入れた利用者 \\ \hline
		key & BIGINT UNSIGNED & UK2, NOT NULL & 確認用キー \\ \hline
		is\_used & TINYINT UNSIGNED & NOT NULL & 使用されたか \\ \hline
		created\_at & DATETIME & & 作成時刻 \\ \hline
		updated\_at & DATETIME & & 更新時刻 \\ \hline
	\end{tabular}
\end{table}
利用者が手に入れた
スタンプはstampsテーブル（\cref{tab:db-stamps}）に
保存する。スタンプの画像はファイルシステムに保存するため、
それに対応するテーブルやカラムは存在しない。
\begin{table}[H]
	\centering
	\caption{stampsテーブル（利用者が手に入れたスタンプ）}\label{tab:db-stamps}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{カラム名} & \thead{データ型} & \thead{制約} & \thead{説明} \\ \hline
		id & INT UNSIGNED & PK & ID \\ \hline
		spot\_id & INT UNSIGNED & FK, UK, NOT NULL & 関連付けたスポット \\ \hline
		user\_id & INT UNSIGNED & FK, UK, NOT NULL & 手に入れた利用者 \\ \hline
		ip\_addr & VARBINARY(16) & NOT NULL & IPアドレス \\ \hline
		port & SMALLINT UNSIGNED & NOT NULL & ポート番号 \\ \hline
		user\_agent & VARCHAR(255) & NOT NULL & User-Agent \\ \hline
		created\_at & DATETIME & & 作成時刻 \\ \hline
		updated\_at & DATETIME & & 更新時刻 \\ \hline
	\end{tabular}
\end{table}
利用者の検索クエリは、事業者の分析に
使用するため、queriesテーブル（\cref{tab:db-queries}）に
保存する。経路検索を伴う場合は、その出発点および目的地も
保存する。
\begin{table}[H]
	\centering
	\caption{queriesテーブル（利用者の検索クエリ）}\label{tab:db-queries}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{カラム名} & \thead{データ型} & \thead{制約} & \thead{説明} \\ \hline
		id & INT UNSIGNED & PK & ID \\ \hline
		user\_id & INT UNSIGNED & FK, NOT NULL & 検索した利用者 \\ \hline
		query & TEXT & NOT NULL & 検索クエリ \\ \hline
		from\_spot\_id & INT UNSIGNED & & 出発地 \\ \hline
		to\_spot\_id & INT UNSIGNED & & 目的地 \\ \hline
		ip\_addr & VARBINARY(16) & NOT NULL & IPアドレス \\ \hline
		port & SMALLINT UNSIGNED & NOT NULL & ポート番号 \\ \hline
		user\_agent & VARCHAR(255) & NOT NULL & User-Agent \\ \hline
		created\_at & DATETIME & & 作成時刻 \\ \hline
		updated\_at & DATETIME & & 更新時刻 \\ \hline
	\end{tabular}
\end{table}
利用者の投稿した写真は、photosテーブル（\cref{tab:db-photos}）に
保存する。地図上に表示するため、写真の経緯度を保存する。
\begin{table}[H]
	\centering
	\caption{photosテーブル（利用者の投稿した写真）}\label{tab:db-photos}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{カラム名} & \thead{データ型} & \thead{制約} & \thead{説明} \\ \hline
		id & INT UNSIGNED & PK & ID \\ \hline
		user\_id & INT UNSIGNED & FK, NOT NULL & 投稿者 \\ \hline
		lng & INT UNSIGNED & NOT NULL & 経度 \\ \hline
		lat & INT UNSIGNED & NOT NULL & 緯度 \\ \hline
		img\_ext & VARCHAR(4) & NOT NULL & 画像の拡張子 \\ \hline
		comment & TEXT & NOT NULL & 写真に付けた文 \\ \hline
		ip\_addr & VARBINARY(16) & NOT NULL & IPアドレス \\ \hline
		port & SMALLINT UNSIGNED & NOT NULL & ポート番号 \\ \hline
		user\_agent & VARCHAR(255) & NOT NULL & User-Agent \\ \hline
		created\_at & DATETIME & & 作成時刻 \\ \hline
		updated\_at & DATETIME & & 更新時刻 \\ \hline
		deleted\_at & DATETIME & & 削除時刻 \\ \hline
	\end{tabular}
\end{table}
事業者の
発行したAPIキーは、api\_keysテーブル（\cref{tab:db-api_keys}）に
保存する。
パスワードと同様にAPIキーもハッシュ化を行い、安全に保存する。
\begin{table}[H]
	\centering
	\caption{api\_keysテーブル（事業者の発行したAPIキー）}\label{tab:db-api_keys}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{カラム名} & \thead{データ型} & \thead{制約} & \thead{説明} \\ \hline
		id & INT UNSIGNED & PK & ID \\ \hline
		user\_id & INT UNSIGNED & FK, NOT NULL & 発行者 \\ \hline
		name & VARCHAR(255) & NOT NULL & 名前 \\ \hline
		key & VARCHAR(255) & NOT NULL & ハッシュ化されたAPIキー \\ \hline
		ip\_addr & VARBINARY(16) & NOT NULL & IPアドレス \\ \hline
		port & SMALLINT UNSIGNED & NOT NULL & ポート番号 \\ \hline
		user\_agent & VARCHAR(255) & NOT NULL & User-Agent \\ \hline
		created\_at & DATETIME & & 作成時刻 \\ \hline
		updated\_at & DATETIME & & 更新時刻 \\ \hline
		deleted\_at & DATETIME & & 削除時刻 \\ \hline
	\end{tabular}
\end{table}

\subsection{データベースアクセス設計}
% 【記述内容】データベースへのアクセス方法、外部設計書で指定された特殊なデータ形式やロジック（ID生成など）の詳細を定義
データベースへのアクセスには、Laravelで
採用されているORMであるEloquentを
用いる。Eloquentでは、\verb|App\Models\|名前空間に
データベースの各テーブルに対応するモデルとなるクラスを
記述する。このクラスにはデータベース上の値をPHP上の
値にどのように相互変換するかなどを記述する。例として、
外部設計書に記述した経緯度の値の格納方法なども
ここに記述する。このクラスをコントローラから使用することで、
データベースの読み書きを行うことができる。

\section{API仕様設計}
\subsection{概要}
本システムが提供する観光データ分析APIは
本サービスでのユーザーの動向を調査し、観光分析に活用できるデータを提供する。
APIへのアクセスにはHTTPリクエストを使用し、レスポンスとしてJSON形式の文字列を返すものとする。

\subsection{トークン（APIキー）の発行}
APIを利用するには予めサービスに対して事業者登録を行い、
トークンの発行を行う必要がある。
トークンの発行はAPIキー管理画面で行うことができる。
システムでは生成したトークンをハッシュ化したものを検証用としてデータベースに保存する。

\subsection{アクセスと認証方法}
APIへのアクセスはHTTPを用いて行う。
分析データを取得するためにはリクエストを送信する。
リクエストにはトークンと取得したい分析データの期間を指定する必要がある。
リクエストはGETメソッドを利用できるものとし、
更に以下の表\ref{tab:api-header}に示すようなヘッダーを利用できるものとする。
\begin{table}[H]
	\centering
	\caption{ヘッダー設定}\label{tab:api-header}
	\begin{tabular}{|l|l|l|}
		\hline
		\thead{フィールド} & \thead{例} & \thead{説明} \\ \hline
		Authorization &  & 認証用トークン \\ \hline
		From-Date & 2025-01-01 & 取得したい期間の始点の日付 \\ \hline
		To-Date & 2025-12-12 & 取得したい期間の終点の日付 \\ \hline
	\end{tabular}
\end{table}

\subsection{分析データ}
ログインに成功すると、ステータスコード200 OKを返し、
リクエストに応じた分析データを返す。
分析データはJSON形式の文字列として返す。
分析データは以下の表\ref{tab:api-response_root}に示すオブジェクトである。
\begin{table}[H]
	\centering
	\caption{分析データ（JSON形式）}\label{tab:api-response_root}
	\begin{tabular}{|l|l|l|}
		\hline
		\thead{キー} & \thead{データ型} & \thead{説明} \\ \hline
		formatVersion & number & 分析データのフォーマットバージョン \\ \hline
		currentUserNum & number & 現在のサービスのユーザー数 \\ \hline
		spotData & Array of Object & スポットに関するデータ（参照: 表\ref{tab:api-response_spots}） \\ \hline
		couponData & Array of Object & クーポンに関するデータ（参照: 表\ref{tab:api-response_coupon}） \\ \hline
	\end{tabular}
\end{table}

\begin{table}[H]
	\centering
	\caption{スポットに関する分析データ（JSON形式）}\label{tab:api-response_spots}
	\begin{tabular}{|l|l|l|}
		\hline
		\thead{キー} & \thead{データ型} & \thead{説明} \\ \hline
		id & string & スポットのID \\ \hline
		fromSpotName & number & 出発地として検索された回数 \\ \hline
		toSpotName & number & 到着地として検索された回数 \\ \hline
		propNum & number & AIによる提案回数 \\ \hline
	\end{tabular}
\end{table}

\begin{table}[H]
	\centering
	\caption{クーポンに関する分析データ（JSON形式）}\label{tab:api-response_spots}
	\begin{tabular}{|l|l|l|}
		\hline
		\thead{キー} & \thead{データ型} & \thead{説明} \\ \hline
		id & string & クーポンのID \\ \hline
		acquisitionNum & number & 取得したユーザー数 \\ \hline
		useNum & number & 使用したユーザー数 \\ \hline
	\end{tabular}
\end{table}

\subsection{ログインの失敗}
トークンにアクセス許可がない、またはトークンが入力されていない場合はログインに失敗する。
このとき、システムはログインの失敗をクライアントに伝えるために
ステータスコード401 Unauthorizedを返す。

\subsection{アクセス制限}
システムは短時間に複数の無効な資格情報を含むリクエストを検知すると
同一発行元のリクエストに対して10分間、ステータスコード403 Forbiddenを返し、
一定時間分析データへのアクセス要求を拒否する。

% ====================================
\newpage
\section{モジュール詳細設計}
% 【記述内容】外部設計書の機能要件を基に、各機能の入出力、責務、および内部処理フローを詳細に定義

\subsection{モデルモジュール}
\subsubsection{例: 利用者モジュール}
\begin{table}[H]
	\centering
	\caption{利用者モジュール}\label{tab:mod-model-user}
	\modtable{MM00}{app/Models/User.php}%
	{データベースのusersテーブルのデータの読み込みおよび書き込みを行う}%
	{
		a [label="ORMのクラスを継承し、データベース内外の値の変換を行う",shape=box,style=rounded];
	}%
	{クラス内の関数の呼び出し}%
	{データベースから得られた値またはデータベースへの書き込み}%
	{}
\end{table}
内容が同一のため省略するが、このモジュールと同様に、
データベースの各テーブルに対応した
モジュールを作成するものとする。
作成する必要のあるモジュールの
一覧を\cref{tab:mod-model-list}に示す。
\begin{table}[H]
	\centering
	\caption{モデルモジュールの一覧}\label{tab:mod-model-list}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{モジュール名} & \thead{モジュールID} & \thead{ファイル名} & \thead{対応するテーブル} \\ \hline
		利用者 & MM00 & User.php & users \\ \hline
		スポット & MM01 & Spot.php & spots \\ \hline
		キーワード & MM02 & Keyword.php & keywords \\ \hline
		口コミ & MM03 & Review.php & reviews \\ \hline
		クーポン & MM04 & Coupon.php & coupons \\ \hline
		利用者クーポン & MM05 & UserCoupon.php & user\_coupons \\ \hline
		スタンプ & MM06 & Stamp.php & stamps \\ \hline
		検索クエリ & MM07 & Query.php & queries \\ \hline
		写真 & MM08 & Photo.php & photos \\ \hline
		APIキー & MM09 & ApiKey.php & api\_keys \\ \hline
	\end{tabular}
\end{table}

\newpage
\subsection{ビューモジュール}
\subsubsection{画面の共通部分出力モジュール}
\begin{table}[H]
	\centering
	\caption{画面の共通部分出力モジュール}\label{tab:mod-view-mf}
	\modtable{MV00}{resources/views/layouts/app.blade.php}%
	{画面の共通部分をテンプレートとして出力}%
	{
		a [label="画面の共通部分を出力",shape=box,style=rounded];
	}%
	{}%
	{画面テンプレート}%
	{}
\end{table}

\newpage
\subsubsection{エラーメッセージ出力モジュール}
\begin{table}[H]
	\centering
	\caption{エラーメッセージ出力モジュール}\label{tab:mod-view-error}
	\modtable{MV01}{resources/views/error.blade.php}%
	{エラーメッセージ表示画面を構成する}%
	{
		node [shape=box,style=rounded];
		a [label="画面の共通部分モジュールを呼び出し"];
		b [label="エラーメッセージ表示画面を構成"];
		b [label="エラーメッセージを表示"];
		c [label="戻るボタンを配置"];
		a -> b -> c;
	}%
	{エラーメッセージ、戻り先URL}%
	{Webページ}%
	{}
\end{table}

\newpage
\subsubsection{例: ログイン画面出力モジュール}
\begin{table}[H]
	\centering
	\caption{ログイン画面出力モジュール}\label{tab:mod-view-login}
	\modtable{MV02}{resources/views/login.blade.php}%
	{ログイン画面を構成する。}%
	{
		node [shape=box,style=rounded];
		a [label="画面の共通部分モジュールを呼び出し"];
		b [label="ログイン画面を構成"];
		a -> b;
	}%
	{}%
	{Webページ}%
	{}
\end{table}
構成する画面が異なるのみであり、
画面の共通部分モジュールを呼び出してそれを基に画面を構成する
部分は同じであるため省略するが、原則このモジュールと同様に
各画面に対応したモジュールを作成するものとする。
作成する必要のあるモジュールの
一覧を\cref{tab:mod-view-list}に示す。
\begin{table}[H]
	\centering
	\caption{ビューモジュールの一覧}\label{tab:mod-view-list}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{モジュール名} & \thead{モジュールID} & \thead{ファイル名} \\ \hline
		画面の共通部分 & MV00 & layouts/app.blade.php \\ \hline
		エラーメッセージ表示画面 & MV01 & error.blade.php \\ \hline
		ログイン画面 & MV02 & login.blade.php \\ \hline
		ホーム画面 & MV03 & root.blade.php \\ \hline
		アカウント情報確認画面 & MV04 & profile.blade.php \\ \hline
		アカウント情報編集画面 & MV05 & profile-edit.blade.php \\ \hline
		事業者申込画面 & MV06 & subscription-form.blade.php \\ \hline
		事業者申込完了画面 & MV07 & subscription-confirm.blade.php \\ \hline
		アカウント作成画面 & MV08 & signup.blade.php \\ \hline
		ログアウト画面 & MV09 & logout.blade.php \\ \hline
		スポット詳細画面 & MV10 & detail.blade.php \\ \hline
		投稿画面 & MV20 & photo.blade.php \\ \hline
		クーポン画面 & MV30 & coupon.blade.php \\ \hline
		クーポン使用画面 & MV31 & coupon-selected.blade.php \\ \hline
		お楽しみ機能画面 & MV40 & funpage.blade.php \\ \hline
		管理者機能ホーム画面 & MV50 & admin.blade.php \\ \hline
		ユーザー一覧画面 & MV51 & user.blade.php \\ \hline
		ユーザー詳細画面 & MV52 & user-detail.blade.php \\ \hline
		UGC監視・管理画面 & MV53 & post.blade.php \\ \hline
		スポット情報編集画面 & MV54 & spot.blade.php \\ \hline
		観光データ確認画面 & MV55 & data.blade.php \\ \hline
		事業者機能ホーム画面 & MV56 & admin.blade.php \\ \hline
		APIキー管理画面 & MV57 & api.blade.php \\ \hline
	\end{tabular}
\end{table}

\newpage
\subsection{コントローラモジュール}
\subsubsection{ログイン処理モジュール}
\begin{table}[H]
	\centering
	\caption{ログイン処理モジュール}\label{tab:mod-create-login}
	\modtable{MC01}{app/Http/Controllers/LoginController.php}%
	{SceneTripのログインを行う。入力値の検証、ログイン名の重複チェック}%
	{
		node [shape=box,style=rounded];%
		b, h, r, k [shape=diamond];
		{ rank=source; b; }
		b [label="ログイン方式は何か？"];
		h [label="入力内容が問題あるか？"];
		i [label="エラーメッセージを含むページを応答"];
		j [label="セッション生成"];%
		k [label="二要素認証は必要か？"];
		l [label="二要素認証画面生成モジュールを呼び出し"];
		m [label="応答"];
		n [label="トップページへのリダイレクトを含む応答"];
		q [label="OAuthを利用して認証を行い、GoogleのIDとユーザー名を取得"];%
		r [label="取得したGoogleのIDが既に登録されているか"];%
		t [label="usersテーブルにGoogleのIDとユーザー名を登録"];%
		b->h [label="SceneTripでログイン"];
		h->i [label="Yes"];%
		h->j [label="No"];%
		j->k;%
		k->l [label="Yes"];%
		k->n [label="No"];
		l->m;
		b->q [label="Googleでログイン"];
		q->r;
		r->k [label="Yes"];%
		r->t [label="No"];
		t->k;
	}%
	{利用者から受け取ったログインに関するHTTPリクエスト}%
	{Webページまたはリダイレクト応答となるHTTPレスポンス}%
	{}
\end{table}

\newpage
\subsubsection{アカウント作成モジュール}
\begin{table}[H]
	\centering
	\caption{アカウント作成モジュール}\label{tab:mod-create-account}
	\modtable{MC02}{app/Http/Controllers/AccountCreateController.php}%
	{SceneTripのアカウント作成を行う。入力値の検証、ログイン名の重複チェック}%
	{
		node [shape=box,style=rounded];
		h [shape=diamond];
		{ rank=source; d; }
		d [label="アカウント作成ボタン選択"];
		e [label="入力値のバリデーションを実行"];
		f [label="ログイン名重複チェックモジュールを呼び出し"];
		h [label="入力内容が問題あるか？"];
		i [label="エラーメッセージを含むページを応答"];
		j [label="usersテーブルにアカウント情報を登録"];
		l [label="ログイン画面へ遷移"];
		d->e->f->h;
		h->i [label="Yes"];
		h->j [label="No"];
		j->l;
		}%
	{利用者から受け取ったアカウント情報を含むHTTPリクエスト}%
	{Webページ}%
	{}
\end{table}

\newpage
\subsubsection{プロフィール画面構成モジュール}
\begin{table}[H]
	\centering
	\caption{プロフィール画面構成モジュール}\label{tab:mod-profile}
	\modtable{MC08}{app/Http/Controllers/ProfileController.php}%
	{SceneTripのプロフィール画面を構成する。}%
	{
		node [shape=box,style=rounded];
		a [label="プロフィールを利用者モジュールを用いて読み込み"];
		b [label="プロフィール画面出力モジュールを呼び出し"];
		a->b;
	}%
	{利用者から受け取ったHTTPリクエスト}%
	{Webページ}%
	{}
\end{table}

\newpage
\subsubsection{プロフィール編集画面構成モジュール}
\begin{table}[H]
	\centering
	\caption{プロフィール編集画面構成モジュール}\label{tab:mod-profile-edit}
	\modtable{MC09}{app/Http/Controllers/ProfileEditController.php}%
	{SceneTripのプロフィール編集画面を構成する。}%
	{
		node [shape=box,style=rounded];
		br1, br2, br3 [shape=diamond];
		{ rank=source; br1; }
		br1 [label="何を編集するのか？"];
		e [label="空白検知モジュールを呼び出し"];
		f [label="ログイン名重複チェックモジュールを呼び出し"];
		br2 [label="入力内容が問題あるか？"];
		g [label="エラーメッセージを含むページを応答"];
		j [label="プロフィール更新処理を実行"];
		k [label="プロフィール更新完了画面出力モジュールを呼び出し"];
		br3 [label="入力内容が問題あるか？"];
		m [label="エラーメッセージを含むページを応答"];
		n [label="画像アップロード処理を実行"];
		o [label="画像アップロード完了画面出力モジュールを呼び出し"];
		br1->e [label="プロフィール情報"];
		e->f->br2;
		br2->g [label="Yes"];
		br2->j [label="No"];
		j->k;
		br1->br3 [label="アイコン"];
		br3->m [label="Yes"];
		br3->n [label="No"];
		n->o;
	}%
	{利用者から受け取ったアカウント情報を含むHTTPリクエスト}%
	{Webページ}%
	{}
\end{table}

\newpage
\subsubsection{二要素認証モジュール}
\begin{table}[H]
	\centering
	\caption{二要素認証モジュール}\label{tab:mod-2fa}
	\modtable{MC12}{app/Http/Controllers/TwoFactorController.php}%
	{利用者がTOTPによる二要素認証を設定・検証・解除するための処理を提供する。}%
	{
		node [shape=box,style=rounded];
		br1, br2, br3 [shape=diamond];
		br1 [label="二要素認証の操作内容は？"];
		b [label="シークレットを生成"];
		c [label="二次元コード化"];
		d [label="二次元コードを含む設定画面を構成"];
		br2 [label="入力されたOTPを検証"];
		e [label="シークレットを暗号化して保存"];
		f [label="設定完了画面に遷移"];
		g [label="エラーメッセージを含むページを応答"];
		br1->b [label="設定"];
		b->c->d;
		br1->br2 [label="検証"];
		br2->br3 [label="成功"];
		br3 [label="検証目的は？"];
		br3->e [label="設定"];
		e->f;
		br2->g [label="失敗"];
		h [label="認証に関するカラムの値を削除"];
		i [label="解除完了画面に遷移"];
		br1->h [label="解除"];
		h->i;
		j [label="ログイン用のセッションを生成"];
		br3->j [label="ログイン"];
	}%
	{利用者から受け取ったHTTPリクエスト}%
	{Webページ}%
	{}
\end{table}

\newpage
\subsubsection{検索画面構成モジュール}
\begin{table}[H]
	\centering
	\caption{検索画面構成モジュール}\label{tab:mod-search-display}
	\modtable{MC00}{app/Http/Controllers/SearchController.php}%
	{検索画面を構成する。検索欄の下部に人気の観光地を一覧表示する}%
	{
		node [shape=box,style=rounded];
		c [label="人気の観光情報をデータベースから取得"];
		d [label="スポット情報を配置した検索画面を構成"];
		c->d;
	}%
	{利用者から受け取ったHTTPリクエスト}%
	{Webページ}%
	{表示するスポット情報は写真、スポット名を含む。}
\end{table}

\newpage
\subsubsection{スポット検索処理モジュール}

\begin{table}[H]
	\centering
	\caption{スポット検索処理モジュール}\label{tab:mod-search}
	\modtable{MU11}{app/Http/Controllers/SearchApiController.php}%
	{キーワード・カテゴリに基づくスポット検索}%
	{
		node [shape=box,style=rounded];
		c [label="入力内容が問題あるか？", shape=diamond];
		c1 [label="エラーメッセージを応答"];
		d [label="検索実行"];
		d1 [label="結果件数が存在するか？", shape=diamond];
		d2 [label="該当するものがない旨を応答"];
		e [label="結果を応答"];
		c->c1 [label="No"];
		c->d [label="Yes"];
		d->d1;
		d1->d2 [label="No"];
		d1->e [label=Yes];
	}%
	{利用者から受け取った検索クエリを含むHTTPリクエスト}%
	{エラーメッセージまたは検索結果リスト}%
	{}
\end{table}

\newpage
\subsubsection{AIスポット推薦処理モジュール}
\begin{table}[H]
	\centering
	\caption{AIスポット推薦処理モジュール}\label{tab:mod-ai}
	\modtable{MU13}{app/Http/Controllers/AiApiController.php}
	{ユーザーのチャット入力に基づくスポット推薦}%
	{
		node [shape=box,style=rounded];
		input [label="チャット入力とスポット情報を受付"];
		calc_bounds [label="検索する範囲を計算"];
		search_db [label="座標の範囲内にあるスポットをデータベース上で検索"];
		check_exist [label="候補が存在するか？", shape=diamond];
		prompt [label="候補リストを含めたプロンプトを構築"];
		apicall [label="Gemini APIへの送信"];
		check_api [label="APIの応答が解釈可能であるか？", shape=diamond];
		parse [label="JSON解析（スポットを抽出）"];
		res_ok [label="推薦文とスポット情報を応答"];
		res_ng [label="エラーまたは候補となるスポットがない旨を応答"];
		input -> calc_bounds;
		calc_bounds -> search_db;
		search_db -> check_exist;
		check_exist -> res_ng [label="No"];
		check_exist -> prompt [label="Yes"];
		prompt -> apicall;
		apicall -> check_api;
		check_api -> res_ng [label="No"];
		check_api -> parse [label="Yes"];
		parse -> res_ok;
	}%
	{チャット入力、出発地、経路について探す場合は目的地も}%
	{推薦スポット情報、推薦理由メッセージ}%
	{
		\parbox[t]{\dimexpr\textwidth-2\tabcolsep\relax}{
			\vspace{-1.7\zw}
			\begin{itemize}
				\item Geminiのハルシネーションの対策として、データベース上に登録されたスポットから絞り込んだ候補を用いる。
				\item 検索する範囲は、周辺または出発地・目的地を結ぶ線分を対角線とした矩形の範囲
			\end{itemize}
			\vspace{-.35\zw}
		}
	}
\end{table}

\newpage
\subsubsection{チェックイン処理モジュール}
\begin{table}[H]
	\centering
	\caption{チェックイン処理モジュール}\label{tab:mod-checkin}
	\modtable{MU14}{app/Http/Controllers/CheckinApiController.php}{送信された二次元コードと位置情報を基にスタンプを付与}
	{
		node [shape=box,style=rounded];
		decodeqr [label="入力内容が問題あるか？", shape=diamond];
		getspot [label="スポットの情報を取得"];
		calcdist [label="スポットとの距離を計算"];
		checkdist [label="距離が50m以下か？", shape=diamond];
		savestamp [label="スタンプモジュールを呼び出しスタンプを記録"];
		checkcoup [label="クーポン受け取りモジュールを呼び出し"];
		msgerror [label="エラーメッセージを応答"];
		decodeqr -> msgerror [label="YeS"];
		decodeqr -> getspot [label="No"];
		getspot -> calcdist -> checkdist;
		checkdist -> msgerror [label="No"];
		checkdist -> savestamp [label="Yes"];
		savestamp -> checkcoup;
	}%
	{利用者から受け取った二次元コード読み取り結果と位置情報を含むHTTPリクエスト}%
	{エラーメッセージまたはスタンプ・クーポン取得結果}%
	{}
\end{table}

\newpage
\subsubsection{口コミ画面構成モジュール}
\begin{table}[H]
	\centering
	\caption{口コミ画面構成モジュール}\label{tab:mod-review-photo}
	\modtable{MU15}{app/Http/Controllers/ReviewController.php}{口コミをシステムに登録する。}%
	{
		node [shape=box,style=rounded];
		validate [label="入力内容が問題あるか？", shape=diamond];
		hasimg [label="画像があるか？", shape=diamond];
		upload [label="画像を保存"];
		checkup [label="保存に成功したか？", shape=diamond];
		savedb [label="口コミモジュールを用いて口コミを記録"];
		success [label="口コミ画面へのリダイレクトを含む応答"];
		error [label="エラーメッセージを含むページを応答"];
		validate -> error [label="Yes"];
		validate -> hasimg [label="No"];
		hasimg -> savedb [label="No"];
		hasimg -> upload [label="Yes"];
		upload -> checkup;
		checkup -> error [label="No"];
		checkup -> savedb [label="Yes"];
		savedb -> success;
	}%
	{利用者から受け取った口コミを含むHTTPリクエスト}%
	{Webページまたはリダイレクト応答となるHTTPレスポンス}%
	{}
\end{table}

\newpage
\subsubsection{クーポン利用開始処理モジュール}
\begin{table}[H]
	\centering
	\caption{クーポン利用開始処理モジュール}\label{tab:mod-coupon-activate}
	\modtable{MU17}{app/Http/Controllers/CouponApiController.php5}
	{クーポンのステータスを「利用可能」から「利用中」に変更する}%
	{
		node [shape=box,style=rounded];
		input [label="クーポンIDを受付"];
		check_owner [label="ユーザーが所持しているか確認", shape=diamond];
		check_status [label="ステータスが「利用可能」か？", shape=diamond];
		check_expire [label="有効期限内であるか？", shape=diamond];
		update [label="ステータスを「利用中」に更新利用開始日時を記録"];
		gen_key [label="確認用キー（署名）の生成"];
		res_ok [label="成功応答（二次元コード用データ含む）"];
		res_ng [label="エラー応答"];
		input -> check_owner;
		check_owner -> res_ng [label="No"];
		check_owner -> check_status [label="Yes"];
		check_status -> res_ng [label="No"];
		check_status -> check_expire [label="Yes"];
		check_expire -> res_ng [label="No"];
		check_expire -> update [label="Yes"];
		update -> gen_key;
		gen_key -> res_ok;
	}
	{クーポンID}%
	{処理結果、二次元コード表示用データ（署名付きトークン）}%
	{UIの「スライドで利用」アクションに対応する}%
\end{table}

\newpage
\subsubsection{投稿マップ表示モジュール}
\begin{table}[H]
	\centering
	\caption{投稿マップ表示モジュール}\label{tab:mod-post-map}
	\modtable{MU19}{app/Http/Controllers/PostMapController.php}%
	{ユーザーの投稿情報を取得し、地図上に表示するデータを構成する}%
	{
		node [shape=box,style=rounded];
		req [label="リクエスト受信"];
		fetch [label="photosテーブルから位置情報付きの投稿を取得"];
		format [label="共通マップモジュール用にデータを整形(JSON化)"];
		render [label="画面テンプレートを描画(共通マップモジュール起動)"];
		req -> fetch;
		fetch -> format;
		format -> render;
	}
	{閲覧範囲または検索条件}%
	{Webページ（投稿が表示された地図画面）}%
	{・「投稿を見る」機能に対応する。}%
\end{table}

\newpage
\subsubsection{スポット追加画面構成モジュール}
\begin{table}[H]
	\centering
	\caption{スポット追加画面構成モジュール}\label{tab:mod-add-spot}
	\modtable{MB00}{app/Http/Controllers/InsertSpotController.php}%
	{スポット追加画面を構成する。}%
	{
		node [shape=box,style=rounded];
		c [label="入力内容が問題あるか？",shape=diamond];
		f [label="エラーメッセージを含むページを応答"];
		g [label="スポットモジュールを用いてスポット追加処理を実行"];
		h [label="スポット一覧画面へのリダイレクトを含む応答"];
		c->f [label="Yes"];
		c->g [label="No"];
		g->h;
	}%
	{利用者から受け取ったスポット情報を含むHTTPリクエスト}%
	{Webページまたはリダイレクト応答となるHTTPレスポンス}%
	{}
\end{table}

\newpage
\subsubsection{スポット編集画面構成モジュール}
\begin{table}[H]
	\centering
	\caption{スポット編集画面構成モジュール}\label{tab:mod-edit-spot}
	\modtable{MB01}{app/Http/Controllers/EditSpotController.php}%
	{スポット編集画面を構成する。}%
	{
		node [shape=box,style=rounded];
		c [label="入力内容が問題あるか？",shape=diamond];
		f [label="エラーメッセージを含むページを応答"];
		g [label="スポットモジュールを用いてスポット編集処理を実行"];
		h [label="スポット一覧画面へのリダイレクトを含む応答"];
		c->f [label="Yes"];
		c->g [label="No"];
		g->h;
	}%
	{利用者から受け取ったスポット情報を含むHTTPリクエスト}%
	{Webページまたはリダイレクト応答となるHTTPレスポンス}%
	{}
\end{table}

\newpage
\subsubsection{スポット削除画面構成モジュール}
\begin{table}[H]
	\centering
	\caption{スポット削除画面構成モジュール}\label{tab:mod-delete-spot}
	\modtable{MB02}{app/Http/Controllers/DeleteSpotController.php}%
	{スポット削除画面を構成する。}%
	{
		node [shape=box,style=rounded];
		c [label="入力内容が問題あるか？",shape=diamond];
		f [label="エラーメッセージを含むページを応答"];
		g [label="スポットモジュールを用いてスポット削除処理を実行"];
		h [label="スポット一覧画面へのリダイレクトを含む応答"];
		c->f [label="Yes"];
		c->g [label="No"];
		g->h;
	}%
	{利用者から受け取ったスポットのIDを含むHTTPリクエスト}%
	{Webページまたはリダイレクト応答となるHTTPレスポンス}%
	{}
\end{table}

\newpage
\subsubsection{利用者追加画面構成モジュール}
\begin{table}[H]
	\centering
	\caption{利用者追加画面構成モジュール}\label{tab:mod-add-user}
	\modtable{MA04}{app/Http/Controllers/InsertUserController.php}%
	{利用者追加画面を構成する。}%
	{
		node [shape=box,style=rounded];
		c [label="入力内容が問題あるか？",shape=diamond];
		f [label="エラーメッセージを含むページを応答"];
		g [label="利用者モジュールを用いて利用者追加処理を実行"];
		h [label="利用者一覧画面へのリダイレクトを含む応答"];
		c->f [label="Yes"];
		c->g [label="No"];
		g->h;
	}%
	{利用者から受け取った利用者情報を含むHTTPリクエスト}%
	{Webページまたはリダイレクト応答となるHTTPレスポンス}%
	{}
\end{table}

\newpage
\subsubsection{利用者編集画面構成モジュール}
\begin{table}[H]
	\centering
	\caption{利用者編集画面構成モジュール}\label{tab:mod-edit-user}
	\modtable{MA05}{app/Http/Controllers/EditUserController.php}%
	{利用者編集画面を構成する。}%
	{
		node [shape=box,style=rounded];
		c [label="入力内容が問題あるか？",shape=diamond];
		f [label="エラーメッセージを含むページを応答"];
		g [label="利用者モジュールを用いて利用者編集処理を実行"];
		h [label="利用者一覧画面へのリダイレクトを含む応答"];
		c->f [label="Yes"];
		c->g [label="No"];
		g->h;
	}%
	{利用者から受け取った利用者情報を含むHTTPリクエスト}%
	{Webページまたはリダイレクト応答となるHTTPレスポンス}%
	{}
\end{table}

\newpage
\subsubsection{利用者削除画面構成モジュール}
\begin{table}[H]
	\centering
	\caption{利用者削除画面構成モジュール}\label{tab:mod-delete-user}
	\modtable{MA06}{app/Http/Controllers/DeleteUserController.php}%
	{利用者削除画面を構成する。}%
	{
		node [shape=box,style=rounded];
		c [label="入力内容が問題あるか？",shape=diamond];
		f [label="エラーメッセージを含むページを応答"];
		g [label="利用者モジュールを用いて利用者削除処理を実行"];
		h [label="利用者一覧画面へのリダイレクトを含む応答"];
		c->f [label="Yes"];
		c->g [label="No"];
		g->h;
	}%
	{利用者から受け取った利用者のIDを含むHTTPリクエスト}%
	{Webページまたはリダイレクト応答となるHTTPレスポンス}%
	{}
\end{table}

\newpage
\subsubsection{UGC監視・管理画面構成モジュール}
\begin{table}[H]
	\centering
	\caption{UGC監視・管理画面構成モジュール}\label{tab:mod-admin-ugc}
	\modtable{MA07}{app/Http/Controllers/AdminUgcController.php}%
	{UGC監視・管理画面を構成する。}%
	{
		node [shape=box,style=rounded];
		c [label="入力内容が問題あるか？",shape=diamond];
		f [label="エラーメッセージを含むページを応答"];
		g [label="口コミモジュールまたは写真モジュールを用いて削除処理を実行"];
		h [label="UGC監視・管理画面へのリダイレクトを含む応答"];
		c->f [label="Yes"];
		c->g [label="No"];
		g->h;
	}%
	{利用者から受け取ったUGCの種別とIDを含むHTTPリクエスト}%
	{Webページまたはリダイレクト応答となるHTTPレスポンス}%
	{}
\end{table}

\newpage
\subsubsection{サブスクリプション承認画面構成モジュール}
\begin{table}[H]
	\centering
	\caption{サブスクリプション承認画面構成モジュール}\label{tab:mod-approve-subs}
	\modtable{MA08}{app/Http/Controllers/SubscriptionApproveController.php}%
	{サブスクリプション承認画面を構成する。}%
	{
		node [shape=box,style=rounded];
		c [label="入力内容が問題あるか？",shape=diamond];
		f [label="エラーメッセージを含むページを応答"];
		g [label="利用者モジュールを用いて承認処理を実行"];
		h [label="承認要求一覧画面へのリダイレクトを含む応答"];
		c->f [label="Yes"];
		c->g [label="No"];
		g->h;
	}%
	{利用者から受け取った利用者のIDを含むHTTPリクエスト}%
	{Webページまたはリダイレクト応答となるHTTPレスポンス}%
	{}
\end{table}

\newpage
\subsection{トレイトモジュール}
\subsubsection{ログイン名重複チェックモジュール}
\begin{table}[H]
	\centering
	\caption{ログイン名重複チェックモジュール}\label{tab:mod-dup}
	\modtable{MC06}{app/Traits/DupLoginNameCheckTrait.php}%
	{ログイン名が重複していないか検査する。}%
	{
		node [shape=box,style=rounded];
		b [shape=diamond];
		{ rank=source; b; }
		b [label="ログイン名が重複しているか？"];
		d [label="エラーメッセージを返す"];
		e [label="重複していない旨を返す"];
		b->d [label="Yes"];
		b->e [label="No"];
	}%
	{}%
	{エラーメッセージまたは重複していない旨}%
	{}
\end{table}

\newpage
\subsubsection{クーポン受け取り処理モジュール}
\begin{table}[H]
	\centering
	\caption{クーポン受け取り処理モジュール}\label{tab:mod-coupon-receive}
	\modtable{MU16}{app/Traits/CouponTrait.php}{スタンプ獲得状況に基づくクーポン付与}%
	{
		node [shape=box,style=rounded];
		fetchcond [label="クーポンモジュールを用いて関連クーポン検索"];
		checkhit [label="対象クーポンがあるか？", shape=diamond];
		checkexpire [label="有効期限内であるか？", shape=diamond];
		savedb [label="利用者クーポンモジュールを用いてデータベースに記録"];
		ressuccess [label="獲得に成功した旨を返す"];
		resnone [label="獲得に失敗した旨を返す"];
		fetchcond -> checkhit;
		checkhit -> resnone [label="No"];
		checkhit -> checkexpire [label="Yes"];
		checkexpire -> resnone [label="No"];
		checkexpire -> savedb [label="Yes"];
		savedb -> ressuccess;
	}%
	{チェックインしたスポット}%
	{獲得に成功したかどうか}%
	{\parbox[t]{\dimexpr\textwidth-2\tabcolsep\relax}{スタンプ獲得トリガーで呼び出される想定。ユーザーが同じクーポンを重複して受け取らないようにする}\vspace{.35\zw}}
\end{table}

\newpage
\subsection{フロントエンドモジュール}
\subsubsection{利用規約確認モジュール}
\begin{table}[H]
	\centering
	\caption{利用規約確認モジュール}\label{tab:mod-terms}
	\modtable{MC03}{resources/ts/terms.ts}%
	{SceneTripの利用規約確認を行う。}%
	{
		node [shape=box,style=rounded];
		{ rank=source; c; }
		c [label="「同意する」ボタンの押下を検知"];
		d [label="アカウント作成画面へ遷移"];
		c->d;
	}%
	{}%
	{}%
	{}
\end{table}

\newpage
\subsubsection{禁止文字検知モジュール}
\begin{table}[H]
	\centering
	\caption{禁止文字検知モジュール}\label{tab:mod-special}
	\modtable{MC05}{resources/ts/special\_char\_check.ts}%
	{入力値に禁止文字が含まれていないか検査
する。}%
	{
		node [shape=box,style=rounded];
		b [shape=diamond];
		a [label="フォームへの入力を検知"];
		b [label="禁止文字が含まれているか？"];
		d [label="エラーメッセージを表示"];
		a->b;
		b->d [label="Yes"];
	}%
	{}%
	{}%
	{}
\end{table}

\newpage
\subsubsection{ログアウト確認モジュール}
\begin{table}[H]
	\centering
	\caption{ログアウト確認モジュール}\label{tab:mod-logout}
	\modtable{MC07}{resources/ts/logout\_confirm.ts}%
	{ログアウトしても良いか確認する。}%
	{
		node [shape=box,style=rounded];
		b [shape=diamond];
		b [label="ボタンの押下を検知"];
		c [label="ログアウトを行うページに遷移"];
		g [label="前のページに戻る"];
		b->c [label="ログアウト"];
		b->g [label="キャンセル"];
	}%
	{}%
	{}%
	{}
\end{table}

\newpage
\subsubsection{Google マップURL生成モジュール}
\begin{table}[H]
	\centering
	\caption{Google マップURL生成モジュール}\label{tab:mod-gmap-gen}
	\modtable{MU18}{resources/ts/gmap\_url.ts}%
	{指定したスポットを巡るGoogle マップの埋め込みURLを生成する}%
	{
		node [shape=box,style=rounded];
		a [label="経由地の数を基にURLの先頭部分を生成"];
		b [label="経由地ごとにパラメータをURLに追加"];
		output [label="生成されたURLを出力"];
		a->b->output;
	}%
	{出発地・経由地・目的地リスト}%
	{Google マップの埋め込みURL}%
	{
		\parbox[t]{\dimexpr\textwidth-2\tabcolsep\relax}{
			\vspace{-1.7\zw}
			\begin{itemize}
				\item 経路や所要時間などの算出は行わず、Google マップへ委譲する。
				\item \texttt{iframe}要素でこのURLを埋め込むことで、リアルタイムの交通状況を反映したナビゲーションを利用できるようにする。
			\end{itemize}
			\vspace{-.35\zw}
		}
	}
\end{table}
URLの先頭部分は、$x=[\text{出発地・目的地を含まない経由地の数}]\times 6$として、
\begin{center}
	\texttt{https://www.google.com/maps/embed?pb=!1m}[$x+28$]\texttt{!!!!!!!!!!!!!!4m}[$x+13$]\texttt{!}
\end{center}
の[]をその中に書いた式の計算結果を10進数のアラビア数字で
置き換えた文字列とする。

ここで、出発地・経由地・目的地となるスポットのリストの
各要素に対して、
\begin{center}
	\texttt{!4m5!!2z}[$y$]\texttt{!!!}
\end{center}
の[$y$]をbase64urlでエンコードした地点名に置き換えた
文字列をURLに追加する処理を行い、
最後の要素まで処理し終わったら、\texttt{!}をURLに追加する。
こうして得られたURLを出力とする。

\subsubsection{住所自動入力モジュール}
\begin{table}[H]
	\centering
	\caption{住所自動入力モジュール}\label{tab:mod-addr}
	\modtable{MB03}{resources/ts/addr.ts}%
	{郵便番号から住所を自動で入力する}%
	{
		node [shape=box,style=rounded];
		a [label="日本郵便のWebサイトよりutf_ken_all.zipをダウンロード"];
		b [label="日本郵便のWebサイトよりjigyosyo.zipをダウンロード"];
		c [label="各ZIPファイルを展開"];
		d [label="自動入力ボタンの押下を待つ"];
		e [label="utf_ken_all.csv内に郵便番号を含むレコードがあるか？",shape=diamond];
		f [label="郵便番号を含む全てのレコードについて、市区町村に続く住所の文字列を表外に示す手法で構築"];
		g [label="郵便番号を含む全てのレコードで共通するデータのみを抽出"];
		h [label="共通する部分があるか？",shape=diamond];
		i [label="郵便番号を自動入力"];
		j [label="JIGYOSYO.CSV内に郵便番号を含むレコードがあるか？",shape=diamond];
		k [label="郵便番号の自動入力ができない旨を表示"];
		a->b->c->d->e;
		e->f [label="Yes"];
		f->g->h;
		h->i [label="Yes"];
		e->j [label="No"];
		h->k [label="No"];
		j->i [label="Yes"];
		j->k [label="No"];
	}%
	{}%
	{}%
	{都道府県および市区町村の自動入力には、市区町村コードのカラムを用いる。}
\end{table}
市区町村の後に続く住所の文字列は、
以下の処理を順に行うことで構築する。
\begin{enumerate}
	\item 町域名が“以下に掲載がない場合”のとき
	（例: \cref{tab:mod-addr-ex-kenall}の〒782--0000）\\
	結果を空文字列として処理を終了する。
	\item 町域名が/（([１-９][０-９]*階|地階・階層不明)）\textdollar/に
	マッチするとき
	（例: \cref{tab:mod-addr-ex-kenall}の名古屋市中村区のもの）\\
	結果を空文字列として処理を終了する。
	\item 町域名が/\textasciicircum(.+)（.+）\textdollar/にマッチするとき
	（例: \cref{tab:mod-addr-ex-kenall}の〒782--0077）\\
	町域名をキャプチャグループに変更して処理を続行する。
	\item 市区町村名のカラムに対して/\textasciicircum.+群/を
	空文字列に置換したものを<市区町村名>とした場合に
	町域名が/\textasciicircum<市区町村名>[の次に.+がくる場合|一円]\textdollar/に
	マッチするとき
	（例: \cref{tab:mod-addr-ex-kenall}の仲多度郡琴平町のものや
	〒781-2110、〒781-6410）\\
	結果を空文字列として処理を終了する。
	\item 町域名が/\textasciicircum(.*).+[、〜]\textbackslash 1.+\textdollar/に
	マッチするとき
	（例: \cref{tab:mod-addr-ex-kenall}の和賀郡西和賀町のものや〒761--4101）\\
	結果をキャプチャグループとして処理を終了する。
	\item 町域名が/\textasciicircum(.+)の次に.+がくる場合\textdollar/に
	マッチするとき
	（例: \cref{tab:mod-addr-ex-kenall}の〒857--2427）\\
	結果をキャプチャグループとして処理を終了する。
	\item 結果を町域名として処理を終了する。
\end{enumerate}
\begin{table}[H]
	\centering
	\caption{\texttt{utf\_ken\_all.csv}のレコード（一部カラムを抜粋）の例}\label{tab:mod-addr-ex-kenall}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{郵便番号} & \thead{市区町村名} & \thead{町域名} \\ \hline
		〒029--5501 & 和賀郡西和賀町 & 左草１地割〜左草６地割 \\ \hline
		〒029--5502 & 和賀郡西和賀町 & 樺沢１６地割、樺沢１７地割 \\ \hline
		〒453--6101 & 名古屋市中村区 & 平池町グローバルゲート（１階） \\ \hline
		〒453--6190 & 名古屋市中村区 & 平池町グローバルゲート（地階・階層不明） \\ \hline
		〒761--4101 & 小豆郡土庄町 & 甲、乙（その他） \\ \hline
		〒766--0001 & 仲多度郡琴平町 & 琴平町の次に４２７番地以降がくる場合（川西） \\ \hline
		〒766--0002 & 仲多度郡琴平町 & 琴平町の次に１〜４２６番地がくる場合（川東） \\ \hline
		〒781--2110 & 吾川郡いの町 & いの町の次に番地がくる場合 \\ \hline
		〒781--6410 & 安芸郡田野町 & 田野町一円 \\ \hline
		〒782--0000 & 香美市 & 以下に掲載がない場合 \\ \hline
		〒782--0003 & 香美市 & 土佐山田町宮ノ口 \\ \hline
		〒782--0077 & 香美市 & 土佐山田町佐野（仁井田） \\ \hline
		〒857--2427 & 西海市 & 大島町の次に番地がくる場合 \\ \hline
	\end{tabular}
\end{table}
\begin{table}[H]
	\centering
	\caption{処理結果の例（空欄は空文字列）}\label{tab:mod-addr-ex-out}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\thead{郵便番号} & \thead{結果} \\ \hline
		〒029--5501 & 左草 \\ \hline
		〒029--5502 & 樺沢１ \\ \hline
		〒453--6101 & \\ \hline
		〒453--6190 & \\ \hline
		〒761--4101 & \\ \hline
		〒766--0001 & \\ \hline
		〒766--0002 & \\ \hline
		〒781--2110 & \\ \hline
		〒781--6410 & \\ \hline
		〒782--0000 & \\ \hline
		〒782--0003 & 土佐山田町宮ノ口 \\ \hline
		〒782--0077 & 土佐山田町佐野 \\ \hline
		〒857--2427 & 大島町\\ \hline
	\end{tabular}
\end{table}

\end{document}
